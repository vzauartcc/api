name: Auto-increment Patch Tag

on:
  push:
    branches:
      - main

jobs:
  tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0 # Required to see all tags, not just the latest commit

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Increment Tag and Push
        run: |
          # Get the latest tag
          LATEST_TAG=$(git tag --sort=creatordate | tail -1)

          if [ -z "$LATEST_TAG" ]; then
            echo "No tags found."
            exit 1
          else
            # Strip the 'v' prefix
            VERSION_NUMBER=${LATEST_TAG#v}

            # Split version parts
            IFS='.' read -r major minor patch <<< "$VERSION_NUMBER"

            # Increment patch
            NEW_PATCH=$((patch + 1))
            NEW_TAG="v$major.$minor.$NEW_PATCH"
          fi

          echo "Existing tag: $LATEST_TAG"
          echo "Creating tag: $NEW_TAG"

          git tag $NEW_TAG
          git push origin $NEW_TAG
